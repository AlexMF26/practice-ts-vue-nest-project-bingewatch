@startuml
class RefreshEntryDataEvent {
    +imdbId: string
}
class RefreshEntryRatingEvent {
    +imdbId: string
}
class EntryEntity {
    +imdbId: string
    +title: string
    +posterUrl: string
    +rating: number
    +seasons: Season[]
    +plot: string
    +rated: string
    +year: string
    +awards: string
    +runtime: string
    +director: string[]
    +writer: string[]
    +actors: string[]
    +genre: string[]
    +language: string[]
}
class Season {
    +episodes: number
}
class EntrySearchResult {
    +imdbId: string
    +title: string
    +posterUrl: string
}
class OpinionEntity {
    +id: string
    +authorId: string
    +entryImdb: string
    +replyToId: string
    +text: string
}
class OmdbService {
    -logger: Logger
    -httpService: HttpService
    +getEntry(id: string): Promise<OmitNever<Pick<OmitNever<Pick<OmdbMovie & OmdbEpisode, "Title" | "Year" | "Rated" | "Released" | "Runtime" | "Genre" | "Director" | "Writer" | "Actors" | "Plot" | "Language" | ... 9 more ... | "Response">> & OmdbSeries, "Title" | ... 19 more ... | "Response">>>
    +getSeason(id: string, seasonNumber: number): Promise<OmdbSeason>
    +search(query: string, page: number): Promise<OmdbSearchResult>
}
class RepositoryService extends PrismaClient {
    -logger: Logger
    +onModuleDestroy(): Promise<void>
    +onModuleInit(): Promise<void>
    +enableShutdownHooks(app: INestApplication): Promise<void>
}
class EntriesService {
    -repositoryService: RepositoryService
    -omdbService: OmdbService
    -logger: Logger
    +findReviewsForEntry(entryId: string): Promise<OpinionEntity[]>
    -getSeason(imdbId: string, seasonNumber: number): Promise<number>
    -getSeasons(imdbId: string): Promise<number[]>
    -create(imdbId: string): Promise<EntryEntity>
    +getEntryByImdbId(imdbId: string): Promise<EntryEntity>
    +refreshRating(imdbId: string): Promise<EntryEntity>
    +refreshData(imdbId: string): Promise<EntryEntity>
    +query(query: string, page: number): Promise<EntrySearchResult[]>
    +getAllIds(): Promise<string[]>
}
class EntriesListener {
    -logger: Logger
    -entriesService: EntriesService
    +refreshRating(payload: RefreshEntryRatingEvent): Promise<EntryEntity>
    +refreshData(payload: RefreshEntryDataEvent): Promise<EntryEntity>
}
class DeleteOpinionEvent {
    +id: string
}
class OpinionsService {
    +logger: Logger
    -repositoryService: RepositoryService
    -watchlistService: WatchlistService
    -usersService: UsersService
    -securityService: SecurityService
    +findRepliesForOpinion(opinionId: string): Promise<OpinionEntity[]>
    +findOpinion(opinionId: string): Promise<OpinionEntity>
    +addReview(authorId: string, entryId: string, text: string): Promise<OpinionEntity>
    +replyToOpinion(opinionId: string, text: string, authorId: string): Promise<OpinionEntity>
    +updateOpinion(opinionId: string, text: string, requesterId: string): Promise<OpinionEntity>
    +deleteOpinion(opinionId: string, requesterId: string): Promise<OpinionEntity>
    +deleteOpinionSafely(opinionId: string): Promise<OpinionEntity>
    -hasUndeletedReplies(opinionId: string): Promise<boolean>
    +getPreservedOpinionsIds(): Promise<string[]>
}
class OpinionsListener {
    -logger: Logger
    -opinionsService: OpinionsService
    +deleteOpinion(payload: DeleteOpinionEvent): Promise<void>
}
class TasksService {
    -logger: Logger
    -eventEmitterService: EventEmitter2
    -entriesService: EntriesService
    -opinionsService: OpinionsService
    +refreshEntities(): Promise<void>
    +opinionsCleanup(): Promise<void>
}
class AppController {
    -logger: Logger
    +getHello(): string
}
EntryEntity --> "*" Season
EntriesService ..> RepositoryService
EntriesService ..> OmdbService
EntriesListener ..> EntriesService
DetailedWatchlistItemEntity --> "1" EntryEntity
UsersService ..> RepositoryService
UsersService ..> SecurityService
WatchlistService ..> RepositoryService
WatchlistService ..> UsersService
WatchlistService ..> EntriesService
WatchlistService ..> SecurityService
OpinionsService ..> RepositoryService
OpinionsService ..> WatchlistService
OpinionsService ..> UsersService
OpinionsService ..> SecurityService
OpinionsListener ..> OpinionsService
TasksService ..> EntriesService
TasksService ..> OpinionsService
@enduml